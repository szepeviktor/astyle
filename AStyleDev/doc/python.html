<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <title>Artistic Style Python</title>
    <meta http-equiv="Content-Language" content="en-us" />
    <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />
    <link href="styles.css" rel="stylesheet" type="text/css" />
    <link href="navajo-night.css" rel="stylesheet" type="text/css" />
</head>

<body>

    <h1>
        Artistic Style Developer Information</h1>

    <h2 class="large">
        Calling Artistic Style from a Python Script</h2>

    <p>
        &nbsp;</p>
    <p class="noindent">
        Artistic style can be called from a Python script, either as an executable or a shared library (DLL). 
        There are three Python scripts in the download along with the test files. The scripts will run on either Python 2 or Python 3.</p>
    <p class="noindent">
        Example.Exe.py calls the Artistic Style executable. An Artistic Style executable
        must be in the same folder as the Python script. The source files are never read by the script. This is the easiest
        way to call the program.</p>
    <p class="noindent">
        The other scripts, ExampleByte.py and ExampleUnicode.py, use Artistic Style as a shared library. The source code
        is read into the program. A shared library
        must be in the same folder as the Python scripts. The two scripts have different ways of handling the Python 3
        Unicode. The following example is ExampleUnicode.py which uses Unicode
        strings and a shared library.</p>

    <h3>
        Compile Options</h3>

    <p>
        To compile Artistic Style as a shared library for use with a Python script the compile option ASTYLE_LIB must be defined. Then it
        will accept the files and options as parameters from a function call instead of the command line. It is the responsibility
        of the calling program to read the source files and accept the options from the user via a graphical interface
        or other method. These are then passed via the function call described below. After the source files are formatted
        they will be returned to the calling program, which must then save the source file and take other appropriate
        action.</p>

    <h3>
        Handling Python 3 Unicode</h3>

    <p>
        Python 3 uses Unicode strings instead of byte strings like Python 2. This can be handled a couple of
        ways when processing disk files and sending them to Artistic Style.
    </p>
    <p>
        One way is to declare the file as binary. This will read the file as a byte string instead of a Unicode string.
        In this case you don't need to be concerned with file encoding and the file can be saved or sent to Artistic Style
        without decoding. The disadvantage of doing this is there are byte strings that you have to keep track of and
        the file is not Unicode. The Python script ExampleByte.py uses this method. The names of byte strings contain the word "byte" so they can be easily identified.</p>
    <p>
        Another way is to read the file as a Unicode string. When this is done it will have to be encoded to be sent to
        Artistic Style or to be saved. This is probably the more common way of handling the problem. The advantage is
        you can work with the file in Unicode. The disadvantage is the encoding and decoding that has to be done and the
        exceptions
        that should be handled. The file ExampleUnicode.py uses this method. This is the method used in the following
        example and that is described in the following discussion.</p>

    <h3>
        AStyleMain Function Call</h3>

    <p>
        The function format_astyle_source<span class="hl opt"></span> is called to format the source code.</p>
    <p>
        Calling the Artistic Style shared library or DLL requires using the Python <strong>ctypes</strong> foreign function library. It provides C compatible
        data types, and allows calling functions in a shared library or DLL.
        All of the text sent to Artistic Style must be in byte format, not Unicode. The entire function is shown so you can see
        the setup for calling Artistic Style. The actual call to Artistic Style is:<br />
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;formatted_text
        = astyle_main(text_in, options, ERROR_HANDLER, MEMORY_ALLOCATION)</p>

    <h4>
        Syntax</h4>

    <div class="python">
        <pre class="python"><span class="hl kwa">def</span> <span class="hl kwd">format_astyle_source</span><span class="hl opt">(</span>libc<span class="hl opt">,</span> text_in<span class="hl opt">,</span> options<span class="hl opt">):</span>
    <span class="hl str">&quot;&quot;&quot;Format the text_in by calling the AStyle shared object (DLL).</span>
<span class="hl str">       The return value is a byte or Unicode string.</span>
<span class="hl str">       If an error occurs, the return value is a NoneType object.</span>
<span class="hl str">       For Python 3:</span>
<span class="hl str">           The text is encoded to utf-8 before calling AStyle.</span>
<span class="hl str">           The text is decoded from utf-8 after being returned.</span>
<span class="hl str">           Using utf-8 will not cause an exception.</span>
<span class="hl str">    &quot;&quot;&quot;</span>
    <span class="hl slc"># version 3 must be encoded to utf-8 bytes</span>
    <span class="hl slc"># encoding to utf-8 will not cause an exception</span>
    <span class="hl kwa">if</span> sys<span class="hl opt">.</span>version_info<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] &gt;=</span> <span class="hl num">3</span><span class="hl opt">:</span>
        text_in <span class="hl opt">=</span> text_in<span class="hl opt">.</span><span class="hl kwd">encode</span><span class="hl opt">(</span><span class="hl str">'utf-8'</span><span class="hl opt">)</span>
        options <span class="hl opt">=</span> options<span class="hl opt">.</span><span class="hl kwd">encode</span><span class="hl opt">(</span><span class="hl str">'utf-8'</span><span class="hl opt">)</span>
    astyle_main <span class="hl opt">=</span> libc<span class="hl opt">.</span>AStyleMain
    astyle_main<span class="hl opt">.</span>restype <span class="hl opt">=</span> c_char_p
    formatted_text <span class="hl opt">= (</span>
            <span class="hl kwd">astyle_main</span><span class="hl opt">(</span>text_in<span class="hl opt">,</span> options<span class="hl opt">,</span> ERROR_HANDLER<span class="hl opt">,</span> MEMORY_ALLOCATION<span class="hl opt">))</span>
    <span class="hl slc"># if an error occurs, the return is a type(None) object</span>
    <span class="hl slc"># Python3 must be decoded to Unicode</span>
    <span class="hl slc"># decoding from utf-8 will not cause an exception</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>sys<span class="hl opt">.</span>version_info<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] &gt;=</span> <span class="hl num">3</span>
    <span class="hl kwa">and</span> <span class="hl kwb">type</span><span class="hl opt">(</span>formatted_text<span class="hl opt">) !=</span> <span class="hl kwb">type</span><span class="hl opt">(</span><span class="hl kwa">None</span><span class="hl opt">)):</span>
        formatted_text <span class="hl opt">=</span> formatted_text<span class="hl opt">.</span><span class="hl kwd">decode</span><span class="hl opt">(</span><span class="hl str">'utf-8'</span><span class="hl opt">)</span>
    <span class="hl kwa">return</span> formatted_text
</pre>
    </div>

    <h4>
        Parameters</h4>
    <p>
        <i>text_in</i><br />
        A byte string containing the source file to be formatted. For Python 3 it is encoded to UTF-8. This is a Unicode
        byte format that can be processed by Artistic Style. Since UTF-8 is a Unicode encoding no errors should occur.</p>
    <p>
        <i>options<span class="hl opt"></span></i><br />
        A byte string containing the formatting options. They should be in the same format as in the default options file.
        The options may be set apart by new-lines, commas, tabs or spaces. The long options do not need the "--" prefix.
        If the file is not a C/C++ file the file mode option "mode=java" or "mode=cs" must be included. Otherwise
        the default mode of C/C++ is used. For Python 3 the options are explicitly declared as byte format with a "b"
        preceding the string.</p>
    <p>
        <i>ERROR_HANDLER</i><br />
        A pointer to the error handling function. This function is called if there are errors in the text_in or options.
        This function and the callback declaration are described below.</p>
    <p>
        <i></i><em>MEMORY_ALLOCATION</em><br />
        A pointer to the memory allocation function. The memory must be allocated for the output source file.
        This function will be called when the memory is needed. This function and the callback declaration are described below.</p>

        <h4>
            Return Value</h4>

    <p>
        The return type is
        declared as c_char_p before the function call.</p>
    <p>
        If the function succeeds, the return value is a <strong>byte</strong> string containing the formatted source code. 
    </p>
    <p>
        If the function fails, the return value is a "NoneType" object. Before the object is returned, an error message will be sent to
        the error handling function.</p>
    <p>
        This function typically fails for one of the following reasons:</p>
    <ul>
        <li>an invalid pointer parameter. </li>
        <li>the memory allocation function MEMORY_ALLOCATION fails. </li>
    </ul>

    <h4>
        Remarks</h4>
    <p>
        The calling program is responsible for freeing the memory allocated by the MEMORY_ALLOCATION function when it
        is no longer needed. In the example this will be done by the MEMORY_ALLOCATION function.</p>

    <h3>
        Callback Functions</h3>

    <p>
        Two function pointers must be defined for the call to AStyleMain.
    </p>

    <h4>
        Memory Allocation Callback</h4>

    <div class="python">
        <pre class="python"><span class="hl slc"># AStyle Memory Allocation Callback</span>
<span class="hl slc"># allocated memory must be global</span>
allocated <span class="hl opt">= []</span>
<span class="hl kwa">def</span> <span class="hl kwd">MemoryAllocation</span><span class="hl opt">(</span>size<span class="hl opt">):</span>
    <span class="hl str">&quot;&quot;&quot;AStyle callback memory allocation.</span>
<span class="hl str">       The size to allocate is always byte type.</span>
<span class="hl str">       The allocated memory must be global.</span>
<span class="hl str">       The previous allocated memory will be freed.</span>
<span class="hl str">    &quot;&quot;&quot;</span>
    arr_type <span class="hl opt">=</span> c_char <span class="hl opt">*</span> size    <span class="hl slc"># create a c_char array</span>
    arr_obj <span class="hl opt">=</span> <span class="hl kwd">arr_type</span><span class="hl opt">()</span>        <span class="hl slc"># create an array object</span>
    allocated<span class="hl opt">.</span><span class="hl kwd">append</span><span class="hl opt">(</span>arr_obj<span class="hl opt">)</span>   <span class="hl slc"># so the object will not be destroyed</span>
    <span class="hl kwa">if</span> <span class="hl kwb">len</span><span class="hl opt">(</span>allocated<span class="hl opt">) &gt;</span> <span class="hl num">1</span><span class="hl opt">:</span>      <span class="hl slc"># free memory for the previous object</span>
        <span class="hl kwa">del</span> allocated<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]</span>
    <span class="hl kwa">return</span> <span class="hl kwd">addressof</span><span class="hl opt">(</span>arr_obj<span class="hl opt">)</span>   <span class="hl slc"># return a pointer</span>

<span class="hl slc"># create the memory allocation callback function</span>
<span class="hl kwa">if</span> os<span class="hl opt">.</span>name <span class="hl opt">==</span> <span class="hl str">&quot;nt&quot;</span><span class="hl opt">:</span>
    MemoryAllocationCallback <span class="hl opt">=</span> <span class="hl kwd">WINFUNCTYPE</span><span class="hl opt">(</span>c_char_p<span class="hl opt">,</span> c_ulong<span class="hl opt">)</span>
<span class="hl kwa">else</span><span class="hl opt">:</span>
    MemoryAllocationCallback <span class="hl opt">=</span> <span class="hl kwd">CFUNCTYPE</span><span class="hl opt">(</span>c_char_p<span class="hl opt">,</span> c_ulong<span class="hl opt">)</span>
MEMORY_ALLOCATION <span class="hl opt">=</span> <span class="hl kwd">MemoryAllocationCallback</span><span class="hl opt">(</span>MemoryAllocation<span class="hl opt">)</span>
</pre>
    </div>

    <h4>
        Remarks</h4>

    <p>
        The parameter to this function is the amount of memory that should be allocated.</p>
    <p>
        The memory allocation callback creates a buffer for accepting the formatted file from Artistic Style. A character
        array is created and moved to a global list. This prevents the object from being deleted when the function ends.
        The previous memory allocation is deleted and a pointer to the array object is returned. </p>
    <p>
        The global instructions
        following the function define the arguments for the callback function used by
        AStyleMain.</p>

    <h4>
        Error Handler Callback</h4>

    <div class="python">
        <pre class="python"><span class="hl slc"># AStyle Error Handler Callback</span>
<span class="hl kwa">def</span> <span class="hl kwd">ErrorHandler</span><span class="hl opt">(</span>num<span class="hl opt">,</span> err<span class="hl opt">):</span>
    <span class="hl str">&quot;&quot;&quot;AStyle callback error handler.</span>
<span class="hl str">       The return error string (err) is always byte type.</span>
<span class="hl str">       It is converted to unicode for Python 3.</span>
<span class="hl str">    &quot;&quot;&quot;</span>
    <span class="hl kwa">print</span><span class="hl opt">(</span><span class="hl str">&quot;Error in input {0}&quot;</span><span class="hl opt">.</span><span class="hl kwd">format</span><span class="hl opt">(</span>num<span class="hl opt">))</span>
    <span class="hl kwa">if</span> sys<span class="hl opt">.</span>version_info<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] &gt;=</span> <span class="hl num">3</span><span class="hl opt">:</span>
        err <span class="hl opt">=</span> err<span class="hl opt">.</span><span class="hl kwd">decode</span><span class="hl opt">()</span>
    <span class="hl kwa">print</span><span class="hl opt">(</span>err<span class="hl opt">)</span>
    sys<span class="hl opt">.</span><span class="hl kwd">exit</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">)</span>

<span class="hl slc"># create the error handler callback function</span>
<span class="hl kwa">if</span> os<span class="hl opt">.</span>name <span class="hl opt">==</span> <span class="hl str">&quot;nt&quot;</span><span class="hl opt">:</span>
    ErrorHandlerCallback <span class="hl opt">=</span> <span class="hl kwd">WINFUNCTYPE</span><span class="hl opt">(</span><span class="hl kwa">None</span><span class="hl opt">,</span> c_int<span class="hl opt">,</span> c_char_p<span class="hl opt">)</span>
<span class="hl kwa">else</span><span class="hl opt">:</span>
    ErrorHandlerCallback <span class="hl opt">=</span> <span class="hl kwd">CFUNCTYPE</span><span class="hl opt">(</span><span class="hl kwa">None</span><span class="hl opt">,</span> c_int<span class="hl opt">,</span> c_char_p<span class="hl opt">)</span>
ERROR_HANDLER <span class="hl opt">=</span> <span class="hl kwd">ErrorHandlerCallback</span><span class="hl opt">(</span>ErrorHandler<span class="hl opt">)</span>
</pre>
    </div>

    <h4>
        Remarks</h4>

    <p>
        The error handler callback displays the error message. For Python 3 the message is decoded to Unicode. Since the
        error messages are in ASCII an exception is not handled. It should display an error message and then either abort or continue the program depending
        on the error. The first parameter is a number identifying the error. The second parameter is a pointer to a standard
        error message.</p>
    <p>
        Error messages numbered 100-199 are errors that prevent the file from being formatted. A NULL pointer is returned
        to the calling program. Error messages numbered 200-299 are errors that do NOT prevent the file from being formatted.
        A valid pointer and a formatted file are returned. This will occur if an invalid option is sent to AStyleMain.
        The calling program has the option of accepting or rejecting the formatted file.</p><p>
            The global instructions following the function define the arguments for the callback function used by AStyleMain.</p>

    <h3>
        AStyleGetVersion Function Call</h3>

    <p>
        This function is called to get the Artistic Style version number.
    </p>
    <p>
        As with calling the format source function, this also requires using the Python <strong>ctypes</strong> foreign
        function library. The entire function is shown so you can see the setup for calling Artistic Style. The actual
        call to Artistic Style is:<br />
        &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;version = astyle_version()</p>

    <h4>
        Syntax</h4>

    <div class="python">
        <pre class="python"><span class="hl kwa">def</span> <span class="hl kwd">get_astyle_version</span><span class="hl opt">(</span>libc<span class="hl opt">):</span>
    <span class="hl str">&quot;&quot;&quot;Get the version number from the AStyle shared object (DLL).</span>
<span class="hl str">       The AStyle return value is always byte type.</span>
<span class="hl str">       It is converted to unicode for Python 3.</span>
<span class="hl str">       Since the version is ascii the decoding will not cause an exception.</span>
<span class="hl str">    &quot;&quot;&quot;</span>
    astyle_version <span class="hl opt">=</span> libc<span class="hl opt">.</span>AStyleGetVersion
    astyle_version<span class="hl opt">.</span>restype <span class="hl opt">=</span> c_char_p
    version <span class="hl opt">=</span> <span class="hl kwd">astyle_version</span><span class="hl opt">()</span>
    <span class="hl kwa">if</span> sys<span class="hl opt">.</span>version_info<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] &gt;=</span> <span class="hl num">3</span><span class="hl opt">:</span>
        version <span class="hl opt">=</span> version<span class="hl opt">.</span><span class="hl kwd">decode</span><span class="hl opt">()</span>
    <span class="hl kwa">return</span> version
</pre>
    </div>

    <h4>
        Return Value</h4>

    <p>
        The return type is declared as c_char_p before the function call.</p>

    <p>
        The return value is the byte string containing the Artistic Style version number.</p>

    <h4>
        Remarks</h4>

    <p>
        For Python 3 the formatted_text is decoded to Unicode. Since it is ASCII characters only, no exceptions should
        occur.</p>

    <h3>
        Example Unicode</h3>

    <p>
        The following example will work with Python 2 or Python 3. For Python 3 it reads the source code disk files as
        Unicode and
        decodes and encodes them as needed. The script can be copied and pasted into an editor for execution. The Artistic
        Style source code must be compiled as a shared library (DLL) using the option ASTYLE_LIB. The shared library must then
        be copied to the directory that contains the script. The directory of the source code files to be formatted is a relative
        path in the function process_files. This may need to be changed to reflect your directory structure.</p>
    <p>
        &nbsp;</p>
    <div class="python">
        <pre class="python">        
<span class="hl slc">#! /usr/bin/python</span>

<span class="hl slc"># ExampleUnicode.py</span>
<span class="hl slc"># This program calls the Artistic Style DLL to format the astyle source files.</span>
<span class="hl slc"># The Artistic Style DLL must be in the same directory as this script.</span>
<span class="hl slc"># The Artistic Style DLL must have the same bit size (32 or 64) as the Python executable.</span>
<span class="hl slc"># It will work with either Python version 2 or 3 (unicode).</span>
<span class="hl slc"># For Python 3 the files are converted to Unicode and encoded or decoded as needed.</span>

<span class="hl slc"># to disable the print statement and use the print() function (version 3 format)</span>
<span class="hl kwa">from</span> __future__ <span class="hl kwa">import</span> print_function

<span class="hl kwa">import</span> os
<span class="hl kwa">import</span> sys
<span class="hl kwa">from</span> ctypes <span class="hl kwa">import</span> <span class="hl opt">*</span>

<span class="hl slc"># -----------------------------------------------------------------------------</span>

<span class="hl kwa">def</span> <span class="hl kwd">process_files</span><span class="hl opt">():</span>
    <span class="hl str">&quot;&quot;&quot;Main processing function.&quot;&quot;&quot;</span>
    options <span class="hl opt">=</span> <span class="hl str">&quot;-A2tOP&quot;</span>
    files <span class="hl opt">= [</span> <span class="hl str">&quot;../test-c/ASBeautifier.cpp&quot;</span><span class="hl opt">,</span>
              <span class="hl str">&quot;../test-c/ASFormatter.cpp&quot;</span> <span class="hl opt">,</span>
              <span class="hl str">&quot;../test-c/astyle.h&quot;</span> <span class="hl opt">]</span>

    libc <span class="hl opt">=</span> <span class="hl kwd">initialize</span><span class="hl opt">()</span>
    <span class="hl kwa">print</span><span class="hl opt">(</span><span class="hl str">&quot;ExampleUnicode Python&quot;</span><span class="hl opt">)</span>
    <span class="hl kwa">print</span><span class="hl opt">(</span><span class="hl str">&quot;Python Version &quot;</span> <span class="hl opt">+</span> <span class="hl kwb">str</span><span class="hl opt">(</span>sys<span class="hl opt">.</span>version_info<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]) +</span>
          <span class="hl str">&quot;.&quot;</span> <span class="hl opt">+</span> <span class="hl kwb">str</span><span class="hl opt">(</span>sys<span class="hl opt">.</span>version_info<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">]))</span>
    version <span class="hl opt">=</span> <span class="hl kwd">get_astyle_version</span><span class="hl opt">(</span>libc<span class="hl opt">)</span>
    <span class="hl kwa">print</span><span class="hl opt">(</span><span class="hl str">&quot;Artistic Style Version &quot;</span> <span class="hl opt">+</span> version<span class="hl opt">)</span>
    <span class="hl slc"># process the input files</span>
    <span class="hl kwa">for</span> file_path <span class="hl kwa">in</span> files<span class="hl opt">:</span>
        text_in <span class="hl opt">=</span> <span class="hl kwd">get_source_code</span><span class="hl opt">(</span>file_path<span class="hl opt">)</span>
        formatted_text <span class="hl opt">=</span> <span class="hl kwd">format_astyle_source</span><span class="hl opt">(</span>libc<span class="hl opt">,</span> text_in<span class="hl opt">,</span> options<span class="hl opt">)</span>
        <span class="hl kwa">if</span> <span class="hl kwb">type</span><span class="hl opt">(</span>formatted_text<span class="hl opt">) ==</span> <span class="hl kwb">type</span><span class="hl opt">(</span><span class="hl kwa">None</span><span class="hl opt">):</span>
            <span class="hl kwa">print</span><span class="hl opt">(</span><span class="hl str">&quot;Error in formatting &quot;</span> <span class="hl opt">+</span> file_path<span class="hl opt">)</span>
            <span class="hl kwa">continue</span>
        <span class="hl kwa">print</span><span class="hl opt">(</span><span class="hl str">&quot;Formatted &quot;</span> <span class="hl opt">+</span> file_path<span class="hl opt">)</span>
        <span class="hl kwd">save_source_code</span><span class="hl opt">(</span>formatted_text<span class="hl opt">,</span> file_path<span class="hl opt">)</span>

<span class="hl slc"># -----------------------------------------------------------------------------</span>

<span class="hl kwa">def</span> <span class="hl kwd">format_astyle_source</span><span class="hl opt">(</span>libc<span class="hl opt">,</span> text_in<span class="hl opt">,</span> options<span class="hl opt">):</span>
    <span class="hl str">&quot;&quot;&quot;Format the text_in by calling the AStyle shared object (DLL).</span>
<span class="hl str">       The return value is a byte or Unicode string.</span>
<span class="hl str">       If an error occurs, the return value is a NoneType object.</span>
<span class="hl str">       For Python 3:</span>
<span class="hl str">           The text is encoded to utf-8 before calling AStyle.</span>
<span class="hl str">           The text is decoded from utf-8 after being returned.</span>
<span class="hl str">           Using utf-8 will not cause an exception.</span>
<span class="hl str">    &quot;&quot;&quot;</span>
    <span class="hl slc"># version 3 must be encoded to utf-8 bytes</span>
    <span class="hl slc"># encoding to utf-8 will not cause an exception</span>
    <span class="hl kwa">if</span> sys<span class="hl opt">.</span>version_info<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] &gt;=</span> <span class="hl num">3</span><span class="hl opt">:</span>
        text_in <span class="hl opt">=</span> text_in<span class="hl opt">.</span><span class="hl kwd">encode</span><span class="hl opt">(</span><span class="hl str">'utf-8'</span><span class="hl opt">)</span>
        options <span class="hl opt">=</span> options<span class="hl opt">.</span><span class="hl kwd">encode</span><span class="hl opt">(</span><span class="hl str">'utf-8'</span><span class="hl opt">)</span>
    astyle_main <span class="hl opt">=</span> libc<span class="hl opt">.</span>AStyleMain
    astyle_main<span class="hl opt">.</span>restype <span class="hl opt">=</span> c_char_p
    formatted_text <span class="hl opt">= (</span>
            <span class="hl kwd">astyle_main</span><span class="hl opt">(</span>text_in<span class="hl opt">,</span> options<span class="hl opt">,</span> ERROR_HANDLER<span class="hl opt">,</span> MEMORY_ALLOCATION<span class="hl opt">))</span>
    <span class="hl slc"># if an error occurs, the return is a type(None) object</span>
    <span class="hl slc"># Python3 must be decoded to Unicode</span>
    <span class="hl slc"># decoding from utf-8 will not cause an exception</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>sys<span class="hl opt">.</span>version_info<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] &gt;=</span> <span class="hl num">3</span>
    <span class="hl kwa">and</span> <span class="hl kwb">type</span><span class="hl opt">(</span>formatted_text<span class="hl opt">) !=</span> <span class="hl kwb">type</span><span class="hl opt">(</span><span class="hl kwa">None</span><span class="hl opt">)):</span>
        formatted_text <span class="hl opt">=</span> formatted_text<span class="hl opt">.</span><span class="hl kwd">decode</span><span class="hl opt">(</span><span class="hl str">'utf-8'</span><span class="hl opt">)</span>
    <span class="hl kwa">return</span> formatted_text

<span class="hl slc"># -----------------------------------------------------------------------------</span>

<span class="hl kwa">def</span> <span class="hl kwd">get_astyle_version</span><span class="hl opt">(</span>libc<span class="hl opt">):</span>
    <span class="hl str">&quot;&quot;&quot;Get the version number from the AStyle shared object (DLL).</span>
<span class="hl str">       The AStyle return value is always byte type.</span>
<span class="hl str">       It is converted to unicode for Python 3.</span>
<span class="hl str">       Since the version is ascii the decoding will not cause an exception.</span>
<span class="hl str">    &quot;&quot;&quot;</span>
    astyle_version <span class="hl opt">=</span> libc<span class="hl opt">.</span>AStyleGetVersion
    astyle_version<span class="hl opt">.</span>restype <span class="hl opt">=</span> c_char_p
    version <span class="hl opt">=</span> <span class="hl kwd">astyle_version</span><span class="hl opt">()</span>
    <span class="hl kwa">if</span> sys<span class="hl opt">.</span>version_info<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] &gt;=</span> <span class="hl num">3</span><span class="hl opt">:</span>
        version <span class="hl opt">=</span> version<span class="hl opt">.</span><span class="hl kwd">decode</span><span class="hl opt">()</span>
    <span class="hl kwa">return</span> version

<span class="hl slc"># -----------------------------------------------------------------------------</span>

<span class="hl kwa">def</span> <span class="hl kwd">get_source_code</span><span class="hl opt">(</span>file_path<span class="hl opt">):</span>
    <span class="hl str">&quot;&quot;&quot;Get the source code (unicode in Version 3).</span>
<span class="hl str">       Opening the file as non-binary will read it as a unicode string.</span>
<span class="hl str">       An exception is handled in case the file cannot be decoding using</span>
<span class="hl str">       the system default codec.</span>
<span class="hl str">       The return value is a unicode string.</span>
<span class="hl str">    &quot;&quot;&quot;</span>
    <span class="hl slc"># version 3 will read unicode since the file is not declared as binary</span>
    <span class="hl slc"># could also read the file as binary and use an explicit decode</span>
    file_in <span class="hl opt">=</span> <span class="hl kwb">open</span><span class="hl opt">(</span>file_path<span class="hl opt">,</span> <span class="hl str">'r'</span><span class="hl opt">)</span>
    <span class="hl kwa">try</span><span class="hl opt">:</span>
        text_in <span class="hl opt">=</span> file_in<span class="hl opt">.</span><span class="hl kwd">read</span><span class="hl opt">()</span>
    <span class="hl kwa">except</span> <span class="hl kwc">UnicodeError</span> <span class="hl kwa">as</span> err<span class="hl opt">:</span>
        <span class="hl slc"># &quot;'&lt;codec&gt;' codec can't decode byte 0x81 in position 40813: &lt;message&gt;&quot;</span>
        <span class="hl kwa">print</span><span class="hl opt">(</span>err<span class="hl opt">)</span>
        <span class="hl kwa">print</span><span class="hl opt">(</span><span class="hl str">&quot;Cannot read &quot;</span> <span class="hl opt">+</span>  file_path<span class="hl opt">)</span>
        sys<span class="hl opt">.</span><span class="hl kwd">exit</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">)</span>
    file_in<span class="hl opt">.</span><span class="hl kwd">close</span><span class="hl opt">()</span>
    <span class="hl kwa">return</span> text_in

<span class="hl slc"># -----------------------------------------------------------------------------</span>

<span class="hl kwa">def</span> <span class="hl kwd">initialize</span><span class="hl opt">():</span>
    <span class="hl str">&quot;&quot;&quot;Set the file path and load the shared object (DLL).</span>
<span class="hl str">       Return the handle to the shared object (DLL).</span>
<span class="hl str">    &quot;&quot;&quot;</span>
    <span class="hl slc"># change directory to the path where this script is located</span>
    pydir <span class="hl opt">=</span> sys<span class="hl opt">.</span>path<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]</span>
    os<span class="hl opt">.</span><span class="hl kwd">chdir</span><span class="hl opt">(</span>pydir<span class="hl opt">)</span>
    <span class="hl slc"># return the handle to the shared object</span>
    <span class="hl kwa">if</span> os<span class="hl opt">.</span>name <span class="hl opt">==</span> <span class="hl str">&quot;nt&quot;</span><span class="hl opt">:</span>
        libc <span class="hl opt">=</span> <span class="hl kwd">load_windows_dll</span><span class="hl opt">()</span>
    <span class="hl kwa">else</span><span class="hl opt">:</span>
        libc <span class="hl opt">=</span> <span class="hl kwd">load_linux_so</span><span class="hl opt">()</span>
    <span class="hl kwa">return</span> libc

<span class="hl slc"># -----------------------------------------------------------------------------</span>

<span class="hl kwa">def</span> <span class="hl kwd">load_linux_so</span><span class="hl opt">():</span>
    <span class="hl str">&quot;&quot;&quot;Load the shared object for Linux platforms.</span>
<span class="hl str">       The shared object must be in the same folder as this python script.</span>
<span class="hl str">    &quot;&quot;&quot;</span>
    so <span class="hl opt">=</span> os<span class="hl opt">.</span>path<span class="hl opt">.</span><span class="hl kwd">join</span><span class="hl opt">(</span>sys<span class="hl opt">.</span>path<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">],</span> <span class="hl str">&quot;libastyle.so&quot;</span><span class="hl opt">)</span>
    <span class="hl kwa">try</span><span class="hl opt">:</span>
        libc <span class="hl opt">=</span> cdll<span class="hl opt">.</span><span class="hl kwd">LoadLibrary</span><span class="hl opt">(</span>so<span class="hl opt">)</span>
    <span class="hl kwa">except</span> <span class="hl kwc">OSError</span> <span class="hl kwa">as</span> err<span class="hl opt">:</span>
        <span class="hl slc"># &quot;cannot open shared object file: No such file or directory&quot;</span>
        <span class="hl kwa">print</span><span class="hl opt">(</span>err<span class="hl opt">)</span>
        <span class="hl kwa">print</span><span class="hl opt">(</span><span class="hl str">&quot;Cannot find &quot;</span> <span class="hl opt">+</span>  so<span class="hl opt">)</span>
        sys<span class="hl opt">.</span><span class="hl kwd">exit</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">)</span>
    <span class="hl kwa">return</span> libc

<span class="hl slc"># -----------------------------------------------------------------------------</span>

<span class="hl kwa">def</span> <span class="hl kwd">load_windows_dll</span><span class="hl opt">():</span>
    <span class="hl str">&quot;&quot;&quot;Load the dll for Windows platforms.</span>
<span class="hl str">       The shared object must be in the same folder as this python script.</span>
<span class="hl str">       An exception is handled if the dll bits do not match the Python</span>
<span class="hl str">       executable bits (32 vs 64).</span>
<span class="hl str">    &quot;&quot;&quot;</span>
    dll <span class="hl opt">=</span> <span class="hl str">&quot;AStyle.dll&quot;</span>
    <span class="hl kwa">try</span><span class="hl opt">:</span>
        libc <span class="hl opt">=</span> windll<span class="hl opt">.</span><span class="hl kwd">LoadLibrary</span><span class="hl opt">(</span>dll<span class="hl opt">)</span>
    <span class="hl kwa">except</span> <span class="hl kwc">WindowsError</span> <span class="hl kwa">as</span> err<span class="hl opt">:</span>
        <span class="hl kwa">print</span><span class="hl opt">(</span>err<span class="hl opt">)</span>
        <span class="hl kwa">if</span> err<span class="hl opt">.</span>args<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] ==</span> <span class="hl num">126</span><span class="hl opt">:</span>      <span class="hl slc">#  &quot;The specified module could not be found&quot;</span>
            <span class="hl kwa">print</span><span class="hl opt">(</span><span class="hl str">&quot;Cannot find &quot;</span> <span class="hl opt">+</span>  dll<span class="hl opt">)</span>
        <span class="hl kwa">if</span> err<span class="hl opt">.</span>args<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] ==</span> <span class="hl num">193</span><span class="hl opt">:</span>      <span class="hl slc">#  &quot;%1 is not a valid Win32 application&quot;</span>
            <span class="hl kwa">print</span><span class="hl opt">(</span><span class="hl str">&quot;You may be mixing 32 and 64 bit code&quot;</span><span class="hl opt">)</span>
        sys<span class="hl opt">.</span><span class="hl kwd">exit</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">)</span>
    <span class="hl kwa">return</span> libc

<span class="hl slc"># -----------------------------------------------------------------------------</span>

<span class="hl kwa">def</span> <span class="hl kwd">save_source_code</span><span class="hl opt">(</span>text_out<span class="hl opt">,</span> file_path<span class="hl opt">):</span>
    <span class="hl str">&quot;&quot;&quot;Save the source code as bytes.</span>
<span class="hl str">       The variable text_out is Unicode in Python 3.</span>
<span class="hl str">       The text_out will be encoded to a byte string using the default codec.</span>
<span class="hl str">       An exception is handled in case the file cannot be encoded.</span>
<span class="hl str">    &quot;&quot;&quot;</span>
    <span class="hl slc"># remove old .orig, if any</span>
    backup_path <span class="hl opt">=</span> file_path <span class="hl opt">+</span> <span class="hl str">&quot;.orig&quot;</span>
    <span class="hl kwa">if</span> os<span class="hl opt">.</span>path<span class="hl opt">.</span><span class="hl kwd">isfile</span><span class="hl opt">(</span>backup_path<span class="hl opt">):</span>
        os<span class="hl opt">.</span><span class="hl kwd">remove</span><span class="hl opt">(</span>backup_path<span class="hl opt">)</span>
    <span class="hl slc"># rename original to backup</span>
    os<span class="hl opt">.</span><span class="hl kwd">rename</span><span class="hl opt">(</span>file_path<span class="hl opt">,</span> backup_path<span class="hl opt">)</span>
    <span class="hl slc"># version 3 will encode the file from unicode using the default codec</span>
    <span class="hl slc"># could also use an explicit decode before wiiting the file</span>
    file_out <span class="hl opt">=</span> <span class="hl kwb">open</span><span class="hl opt">(</span>file_path<span class="hl opt">,</span> <span class="hl str">'w'</span><span class="hl opt">)</span>
    <span class="hl kwa">try</span><span class="hl opt">:</span>
        file_out<span class="hl opt">.</span><span class="hl kwd">write</span><span class="hl opt">(</span>text_out<span class="hl opt">)</span>
    <span class="hl kwa">except</span> <span class="hl kwc">UnicodeError</span> <span class="hl kwa">as</span> err<span class="hl opt">:</span>
        <span class="hl slc"># &quot;'&lt;codec&gt;' codec can't encode characters in position 0-2: &lt;message&gt;&quot;</span>
        <span class="hl kwa">print</span><span class="hl opt">(</span>err<span class="hl opt">)</span>
        <span class="hl kwa">print</span><span class="hl opt">(</span><span class="hl str">&quot;Cannot write &quot;</span> <span class="hl opt">+</span>  file_path<span class="hl opt">)</span>
        sys<span class="hl opt">.</span><span class="hl kwd">exit</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">)</span>
    file_out<span class="hl opt">.</span><span class="hl kwd">close</span><span class="hl opt">()</span>

<span class="hl slc"># -----------------------------------------------------------------------------</span>

<span class="hl slc"># // astyle ASTYLE_LIB declarations</span>
<span class="hl slc"># typedef void (STDCALL *fpError)(int, char*);       // pointer to callback error handler</span>
<span class="hl slc"># typedef char* (STDCALL *fpAlloc)(unsigned long);   // pointer to callback memory allocation</span>
<span class="hl slc"># extern &quot;C&quot; EXPORT char* STDCALL AStyleMain(const char*, const char*, fpError, fpAlloc);</span>
<span class="hl slc"># extern &quot;C&quot; EXPORT const char* STDCALL AStyleGetVersion (void);</span>

<span class="hl slc"># -----------------------------------------------------------------------------</span>

<span class="hl slc"># AStyle Error Handler Callback</span>
<span class="hl kwa">def</span> <span class="hl kwd">ErrorHandler</span><span class="hl opt">(</span>num<span class="hl opt">,</span> err<span class="hl opt">):</span>
    <span class="hl str">&quot;&quot;&quot;AStyle callback error handler.</span>
<span class="hl str">       The return error string (err) is always byte type.</span>
<span class="hl str">       It is converted to unicode for Python 3.</span>
<span class="hl str">    &quot;&quot;&quot;</span>
    <span class="hl kwa">print</span><span class="hl opt">(</span><span class="hl str">&quot;Error in input {0}&quot;</span><span class="hl opt">.</span><span class="hl kwd">format</span><span class="hl opt">(</span>num<span class="hl opt">))</span>
    <span class="hl kwa">if</span> sys<span class="hl opt">.</span>version_info<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] &gt;=</span> <span class="hl num">3</span><span class="hl opt">:</span>
        err <span class="hl opt">=</span> err<span class="hl opt">.</span><span class="hl kwd">decode</span><span class="hl opt">()</span>
    <span class="hl kwa">print</span><span class="hl opt">(</span>err<span class="hl opt">)</span>
    sys<span class="hl opt">.</span><span class="hl kwd">exit</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">)</span>

<span class="hl slc"># create the error handler callback function</span>
<span class="hl kwa">if</span> os<span class="hl opt">.</span>name <span class="hl opt">==</span> <span class="hl str">&quot;nt&quot;</span><span class="hl opt">:</span>
    ErrorHandlerCallback <span class="hl opt">=</span> <span class="hl kwd">WINFUNCTYPE</span><span class="hl opt">(</span><span class="hl kwa">None</span><span class="hl opt">,</span> c_int<span class="hl opt">,</span> c_char_p<span class="hl opt">)</span>
<span class="hl kwa">else</span><span class="hl opt">:</span>
    ErrorHandlerCallback <span class="hl opt">=</span> <span class="hl kwd">CFUNCTYPE</span><span class="hl opt">(</span><span class="hl kwa">None</span><span class="hl opt">,</span> c_int<span class="hl opt">,</span> c_char_p<span class="hl opt">)</span>
ERROR_HANDLER <span class="hl opt">=</span> <span class="hl kwd">ErrorHandlerCallback</span><span class="hl opt">(</span>ErrorHandler<span class="hl opt">)</span>

<span class="hl slc"># -----------------------------------------------------------------------------</span>

<span class="hl slc"># AStyle Memory Allocation Callback</span>
<span class="hl slc"># allocated memory must be global</span>
allocated <span class="hl opt">= []</span>
<span class="hl kwa">def</span> <span class="hl kwd">MemoryAllocation</span><span class="hl opt">(</span>size<span class="hl opt">):</span>
    <span class="hl str">&quot;&quot;&quot;AStyle callback memory allocation.</span>
<span class="hl str">       The size to allocate is always byte type.</span>
<span class="hl str">       The allocated memory must be global.</span>
<span class="hl str">       The previous allocated memory will be freed.</span>
<span class="hl str">    &quot;&quot;&quot;</span>
    arr_type <span class="hl opt">=</span> c_char <span class="hl opt">*</span> size    <span class="hl slc"># create a c_char array</span>
    arr_obj <span class="hl opt">=</span> <span class="hl kwd">arr_type</span><span class="hl opt">()</span>        <span class="hl slc"># create an array object</span>
    allocated<span class="hl opt">.</span><span class="hl kwd">append</span><span class="hl opt">(</span>arr_obj<span class="hl opt">)</span>   <span class="hl slc"># so the object will not be destroyed</span>
    <span class="hl kwa">if</span> <span class="hl kwb">len</span><span class="hl opt">(</span>allocated<span class="hl opt">) &gt;</span> <span class="hl num">1</span><span class="hl opt">:</span>      <span class="hl slc"># free memory for the previous object</span>
        <span class="hl kwa">del</span> allocated<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]</span>
    <span class="hl kwa">return</span> <span class="hl kwd">addressof</span><span class="hl opt">(</span>arr_obj<span class="hl opt">)</span>   <span class="hl slc"># return a pointer</span>

<span class="hl slc"># create the memory allocation callback function</span>
<span class="hl kwa">if</span> os<span class="hl opt">.</span>name <span class="hl opt">==</span> <span class="hl str">&quot;nt&quot;</span><span class="hl opt">:</span>
    MemoryAllocationCallback <span class="hl opt">=</span> <span class="hl kwd">WINFUNCTYPE</span><span class="hl opt">(</span>c_char_p<span class="hl opt">,</span> c_ulong<span class="hl opt">)</span>
<span class="hl kwa">else</span><span class="hl opt">:</span>
    MemoryAllocationCallback <span class="hl opt">=</span> <span class="hl kwd">CFUNCTYPE</span><span class="hl opt">(</span>c_char_p<span class="hl opt">,</span> c_ulong<span class="hl opt">)</span>
MEMORY_ALLOCATION <span class="hl opt">=</span> <span class="hl kwd">MemoryAllocationCallback</span><span class="hl opt">(</span>MemoryAllocation<span class="hl opt">)</span>

<span class="hl slc"># -----------------------------------------------------------------------------</span>

<span class="hl slc"># make the module executable</span>
<span class="hl kwa">if</span> __name__ <span class="hl opt">==</span> <span class="hl str">&quot;__main__&quot;</span><span class="hl opt">:</span>
    <span class="hl kwd">process_files</span><span class="hl opt">()</span>
    sys<span class="hl opt">.</span><span class="hl kwd">exit</span><span class="hl opt">()</span>

</pre>
    </div>
    <p>
        &nbsp;</p>

    <center style="margin-left: -0.4in;">
        <a href="http://sourceforge.net/projects/astyle">
            <img src="http://sflogo.sourceforge.net/sflogo.php?group_id=2319&type=16" width="150" height="40" alt="[SourceForge.net]" /></a>
    </center>

    <p>
        &nbsp;</p>
</body>

</html>


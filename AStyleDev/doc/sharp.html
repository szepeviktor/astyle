<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <title>Artistic Style C#</title>
    <meta http-equiv="Content-Language" content="en-us" />
    <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />
    <link href="styles.css" rel="stylesheet" type="text/css" />
    <link href="highlight-typical.css" rel="stylesheet" type="text/css" />
</head>

<body>

    <h1>
        Artistic Style Developer Information</h1>

    <h2 class="large">
        Calling Artistic Style from a C# Program</h2>

    <p>
        &nbsp;</p>
    <p class="noindent">
        Artistic Style can be compiled as a shared library (DLL) and called from a C# program.</p>
    <p class="noindent">
        A compiled C# program can be run on any platform. Artistic Style, however, is a C++ program and must be compiled
        on the platform on which it will run. Once this is done Artistic Style can be called from a C# program.
    </p>

    <h3>
        Compile Options</h3>

    <p>
        To compile Artistic Style for use with a C# program the compile option ASTYLE_LIB must be defined. Then it will
        accept the files and options as parameters from a function call instead of the command line. It is the responsibility
        of the calling program to read the source files and accept the options from the user via a Graphical User Interface
        (GUI). These are then passed via the function call described below. After the source files are formatted they
        will be returned to the calling program, which must then save the source file and take other appropriate action.</p>

    <h3>
        AStyleMain Method</h3>

    <p>
        This function is called to format the source code.</p>

    <h4>
        Syntax</h4>

    <div class="code">
        <pre><span class="hl sym">[</span><span class="hl kwd">DllImport</span><span class="hl sym">(</span><span class="hl str">&quot;astyle&quot;</span><span
            class="hl sym">,</span> CallingConvention <span class="hl sym">=</span> CallingConvention<span class="hl sym">.</span>StdCall<span
                class="hl sym">)]</span>
<span class="hl kwa">private static</span> extern IntPtr AStyleMain
<span class="hl sym">(</span>
    <span class="hl sym">[</span><span class="hl kwd">MarshalAs</span><span class="hl sym">(</span>UnmanagedType<span
        class="hl sym">.</span>LPStr<span class="hl sym">)]</span> String sIn<span class="hl sym">,</span>
    <span class="hl sym">[</span><span class="hl kwd">MarshalAs</span><span class="hl sym">(</span>UnmanagedType<span
        class="hl sym">.</span>LPStr<span class="hl sym">)]</span> String sOptions<span class="hl sym">,</span>
    AStyleErrorDelgate errorFunc<span class="hl sym">,</span>
    AStyleMemAllocDelgate memAllocFunc
<span class="hl sym">);</span>
</pre>
    </div>

    <h4>
        Parameters</h4>

    <p>
        <i>sIn</i><br />A C# string containing the source file to be formatted.</p>
    <p>
        <i>sOptions</i><br />A C# string containing the formatting options. They should be in the same format as in the
        default options file. The options may be set apart by new-lines, tabs or spaces. The long options do not need
        the "--" prefix.</p>
    <p>
        For a C# file the file mode option "mode=cs" must be included. Otherwise the default mode of C/C++ is used.</p>
    <p>
        <i>errorFunc</i><br />A delegate containing the error handling function. If there are errors in the parameters
        sIn or sOptions, this function is called. It should display an error message and then either abort or continue
        the program depending on the error. The first parameter is a number identifying the error. The second parameter
        is a pointer to a standard error message.</p>
    <p>
        Error messages numbered 100-199 are errors that prevent the file from being formatted. A NULL pointer is returned
        to the calling program. Error messages numbered 200-299 are errors that do NOT prevent the file from being formatted.
        A valid pointer and a formatted file are returned. This will occur if an invalid option is sent to AStyleMain.
        The calling program has the option of accepting or rejecting the formatted file.</p>
    <p>
        <i>memAllocFunc</i><br />A delegate to the memory allocation function. The calling program must allocate memory
        for the output source file. This function will be called when the memory is needed. The parameter is the amount
        of memory that should be allocated.</p>
    <p>
        Memory should be allocated using Marshal.AllocHGlobal. With this method, if there is an allocation exception,
        a NULL pointer will be sent to AStyleMain. Artistic Style will generate an error message and return a NULL pointer
        from the AStyleMain function. The calling program can handle the exception at this point rather than in the memory
        allocation function. See the following example program for the procedure.</p>
    <p>
        The calling program is responsible for freeing the allocated memory when it is no longer required.</p>

    <h4>
        Return Value</h4>

    <p>
        If the function succeeds, the return value is an IntPtr to the formatted source code. The IntPtr should be converted
        to a C# string using Marshal.PtrToStringAnsi.</p>
    <p>
        If the function fails, the return value is NULL. Before the NULL is returned, an error message will be sent to
        the error handling function.</p>
    <p>
        This function typically fails for one of the following reasons:</p>
    <ul>
        <li>an invalid parameter value, usually a NULL pointer.</li>
        <li>the memory allocation function (memAllocFunc) returns a NULL.</li>
    </ul>

    <h4>
        Remarks</h4>

    <p>
        The calling program is responsible for freeing the memory allocated by memAllocFunc when it is no longer needed.</p>
    <p>
        The call to AStyleMain should be placed in a try/catch block that contains a DllNotFoundException to handle a
        missing shared library and an EntryPointNotFoundException to handle not finding the entry point. It should also
        allow for a NULL return value from Artistic Style.</p>

    <h3>
        Callback Methods</h3>

    <p>
        Callback methods must be delegated for the call to AStyleMain.
    </p>

    <h4>
        Syntax</h4>

    <div class="code">
        <pre><span class="hl slc">// AStyleMain callbacks</span>
<span class="hl kwa">private delegate</span> IntPtr <span class="hl kwd">AStyleMemAllocDelgate</span><span class="hl sym">(</span><span
    class="hl kwb">int</span> size<span class="hl sym">);</span>
<span class="hl kwa">private delegate</span> <span class="hl kwb">void</span> AStyleErrorDelgate
<span class="hl sym">(</span>
    <span class="hl kwb">int</span> errorNum<span class="hl sym">,</span>
    <span class="hl sym">[</span><span class="hl kwd">MarshalAs</span><span class="hl sym">(</span>UnmanagedType<span
        class="hl sym">.</span>LPStr<span class="hl sym">)]</span> String error
<span class="hl sym">);</span>

<span class="hl slc">// AStyleMain Delegates</span>
<span class="hl kwa">private</span> AStyleMemAllocDelgate AStyleMemAlloc<span class="hl sym">;</span>
<span class="hl kwa">private</span> AStyleErrorDelgate AStyleError<span class="hl sym">;</span>

<span class="hl slc">/// Declare callback functions</span>
<span class="hl kwa">public</span> <span class="hl kwd">AStyleInterface</span><span class="hl sym">()</span>
<span class="hl sym">{</span>
    AStyleMemAlloc <span class="hl sym">=</span> <span class="hl kwa">new</span> <span class="hl kwd">AStyleMemAllocDelgate</span><span
        class="hl sym">(</span>OnAStyleMemAlloc<span class="hl sym">);</span>
    AStyleError <span class="hl sym">=</span> <span class="hl kwa">new</span> <span class="hl kwd">AStyleErrorDelgate</span><span
        class="hl sym">(</span>OnAStyleError<span class="hl sym">);</span>
<span class="hl sym">}</span>
</pre>
    </div>

    <h4>
        Remarks</h4>

    <p>
        The methods OnAStyleMemAlloc and OnAStyleError contain the memory allocation and error handling methods. These
        methods must be written to allocate the required memory and process any errors returned from AStyleMain. The delegates
        AStyleMemAllocDelgate and AStyleErrorDelgate are used in the call to AStyleMain. The delegates are similar to
        C++ function pointers, but are type safe.</p>
    <p>
        <i>AStyleErrorDelgate</i><br />OnAStyleError is called if there are errors in the string parameters in the call
        to AStyleMain. It should display an error message and then either abort or continue the program depending on the
        error. The first parameter is a number identifying the error. The second parameter is a pointer to a standard
        error message.</p>
    <p>
        Error messages numbered 100-199 are errors that prevent the file from being formatted. A NULL pointer is returned
        to the calling program. Error messages numbered 200-299 are errors that do NOT prevent the file from being formatted.
        A valid string containing a formatted file is returned. This will occur if an invalid option is sent to AStyleMain.
        The calling program has the option of accepting or rejecting the formatted file.</p>
    <p>
        <i>AStyleMemAllocDelgate</i><br />OnAStyleMemAlloc is the memory allocation method. The program must allocate
        memory for the output source file. This function will be called when the memory is needed. The parameter is the
        amount of memory that should be allocated. The return value to Artistic Style is an IntPtr to the new allocated
        memory. The&nbsp; IntPtr should be converted to a C# string using Marshal.PtrToStringAnsi.</p>
    <p>
        The calling program is responsible for freeing the memory allocated by memAllocFunc when it is no longer needed.</p>

    <h3>
        AStyleGetVersion Method</h3>

    <p>
        This function is called to get the Artistic Style version number.
    </p>

    <h4>
        Syntax</h4>

    <div class="code">
        <pre><span class="hl sym">[</span><span class="hl kwd">DllImport</span><span class="hl sym">(</span><span class="hl str">&quot;astyle&quot;</span><span
            class="hl sym">,</span> CallingConvention <span class="hl sym">=</span> CallingConvention<span class="hl sym">.</span>StdCall<span
                class="hl sym">)]</span>
<span class="hl kwa">private static</span> extern IntPtr <span class="hl kwd">AStyleGetVersion</span><span class="hl sym">();</span>
</pre>
    </div>

    <h4>
        Return Value</h4>

    <p>
        The return value is an IntPtr to the Artistic Style version number. The IntPtr should be converted to a C# string
        using Marshal.PtrToStringAnsi.</p>

    <h4>
        Remarks</h4>

    <p>
        The call to AStyleGetVersion should be placed in a try/catch block that contains a DllNotFoundException to handle
        a missing shared library and an EntryPointNotFoundException to handle not finding the entry point.</p>

    <h3>
        Example</h3>

    <p>
        The following example formats source files by calling the Artistic Style formatter. It is a console application
        but the procedure for a GUI is the same. The two classes can be copied and pasted into a source files. The Artistic
        Style source code must be compiled as a shared library (DLL) using the option ASTYLE_LIB. The shared library must
        be copied to the directory that contains the C# executable (it is loaded from the current directory).</p>
    <p>
        &nbsp;</p>
    <div class="code">
        <pre> 
<span class="hl slc">// Example.cs</span>

<span class="hl kwa">using</span> System<span class="hl sym">;</span>
<span class="hl kwa">using</span> System<span class="hl sym">.</span>IO<span class="hl sym">;</span>
<span class="hl kwa">using</span> System<span class="hl sym">.</span>Text<span class="hl sym">;</span>

<span class="hl slc">/// Example opens the source files, calls the AStyleInterface methods</span>
<span class="hl slc">/// to format the files, and saves the reformatted source. The files</span>
<span class="hl slc">/// are in a test-s directory. The option mode=cs must be included</span>
<span class="hl slc">/// for C# files.</span>
<span class="hl kwa">public class</span> Example
<span class="hl sym">{</span>
    <span class="hl slc">/// Main function for Example</span>
    <span class="hl kwa">public static</span> <span class="hl kwb">void</span> <span class="hl kwd">Main</span><span class="hl sym">(</span><span class="hl kwb">string</span><span class="hl sym">[]</span> args<span class="hl sym">)</span>
    <span class="hl sym">{</span>
        <span class="hl slc">// files to pass to AStyle</span>
        String<span class="hl sym">[]</span> fileName <span class="hl sym">=  {</span> <span class="hl str">&quot;../test-s/FileUtility.cs&quot;</span><span class="hl sym">,</span>
                               <span class="hl str">&quot;../test-s/MainClass.cs&quot;</span> <span class="hl sym">,</span>
                               <span class="hl str">&quot;../test-s/StringParser.cs&quot;</span> <span class="hl sym">,</span>
                             <span class="hl sym">};</span>

        <span class="hl slc">// options to pass to AStyle</span>
        <span class="hl slc">// mode=cs is required for C# files</span>
        String options <span class="hl sym">=</span> <span class="hl str">&quot;brackets=linux mode=cs&quot;</span><span class="hl sym">;</span>

        <span class="hl slc">// create an object</span>
        AStyleInterface AStyle <span class="hl sym">=</span> <span class="hl kwa">new</span> <span class="hl kwd">AStyleInterface</span><span class="hl sym">();</span>

        <span class="hl slc">// get Artistic Style version</span>
        <span class="hl slc">// does not need to terminate on an error</span>
        String version <span class="hl sym">=</span> AStyle<span class="hl sym">.</span><span class="hl kwd">GetVersion</span><span class="hl sym">();</span>
        <span class="hl kwa">if</span> <span class="hl sym">(</span>version <span class="hl sym">!=</span> String<span class="hl sym">.</span>Empty<span class="hl sym">)</span>
            Console<span class="hl sym">.</span><span class="hl kwd">WriteLine</span> <span class="hl sym">(</span><span class="hl str">&quot;AStyle Version &quot;</span> <span class="hl sym">+</span> version<span class="hl sym">);</span>

        <span class="hl slc">// process the files</span>
        <span class="hl kwa">for</span> <span class="hl sym">(</span><span class="hl kwb">int</span> i <span class="hl sym">=</span> <span class="hl num">0</span><span class="hl sym">;</span> i <span class="hl sym">&lt;</span> fileName<span class="hl sym">.</span>Length<span class="hl sym">;</span> i<span class="hl sym">++) {</span>
            <span class="hl slc">// get the text to format</span>
            String textIn <span class="hl sym">=</span> <span class="hl kwd">GetText</span><span class="hl sym">(</span>fileName<span class="hl sym">[</span>i<span class="hl sym">]);</span>

            <span class="hl slc">// call the Artistic Style formatting function</span>
            <span class="hl slc">// does not need to terminate on an error</span>
            String textOut <span class="hl sym">=</span> AStyle<span class="hl sym">.</span><span class="hl kwd">FormatSource</span><span class="hl sym">(</span>textIn<span class="hl sym">,</span> options<span class="hl sym">);</span>
            <span class="hl kwa">if</span> <span class="hl sym">(</span>textOut <span class="hl sym">==</span> String<span class="hl sym">.</span>Empty<span class="hl sym">) {</span>
                Console<span class="hl sym">.</span><span class="hl kwd">WriteLine</span><span class="hl sym">(</span><span class="hl str">&quot;cannot format &quot;</span>  <span class="hl sym">+</span> fileName<span class="hl sym">[</span>i<span class="hl sym">]);</span>
                <span class="hl kwa">continue</span><span class="hl sym">;</span>
            <span class="hl sym">}</span>

            <span class="hl slc">// return the formatted text</span>
            Console<span class="hl sym">.</span><span class="hl kwd">WriteLine</span><span class="hl sym">(</span><span class="hl str">&quot;formatted &quot;</span> <span class="hl sym">+</span> fileName<span class="hl sym">[</span>i<span class="hl sym">]);</span>
            <span class="hl kwd">SetText</span><span class="hl sym">(</span>textOut<span class="hl sym">,</span> fileName<span class="hl sym">[</span>i<span class="hl sym">]);</span>
        <span class="hl sym">}</span>

        <span class="hl kwa">return</span><span class="hl sym">;</span>
    <span class="hl sym">}</span>

    <span class="hl slc">///  Error message function for this example.</span>
    <span class="hl kwa">private static</span> <span class="hl kwb">void</span> <span class="hl kwd">Error</span><span class="hl sym">(</span>String why<span class="hl sym">,</span> String what<span class="hl sym">)</span>
    <span class="hl sym">{</span>
        Console<span class="hl sym">.</span><span class="hl kwd">WriteLine</span><span class="hl sym">(</span>why <span class="hl sym">+</span> <span class="hl str">' '</span> <span class="hl sym">+</span> what<span class="hl sym">);</span>
        Console<span class="hl sym">.</span><span class="hl kwd">WriteLine</span><span class="hl sym">(</span><span class="hl str">&quot;The program has terminated!&quot;</span><span class="hl sym">);</span>
        Environment<span class="hl sym">.</span><span class="hl kwd">Exit</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">);</span>
    <span class="hl sym">}</span>

    <span class="hl slc">///  Get the text to be formatted.</span>
    <span class="hl slc">///  Usually the text would be obtained from an edit control.</span>
    <span class="hl kwa">private static</span> String <span class="hl kwd">GetText</span><span class="hl sym">(</span><span class="hl kwb">string</span> fileName<span class="hl sym">)</span>
    <span class="hl sym">{</span>
        <span class="hl slc">// create input buffers</span>
        <span class="hl kwb">int</span> readSize <span class="hl sym">=</span> <span class="hl num">1024</span><span class="hl sym">;</span>
        StringBuilder bufferIn <span class="hl sym">=</span> <span class="hl kwa">new</span> <span class="hl kwd">StringBuilder</span><span class="hl sym">(</span>readSize<span class="hl sym">);</span>
        <span class="hl kwb">char</span><span class="hl sym">[]</span> fileIn <span class="hl sym">=</span> <span class="hl kwa">new</span> <span class="hl kwb">char</span><span class="hl sym">[</span>readSize<span class="hl sym">];</span>

        <span class="hl slc">// read file data</span>
        <span class="hl kwa">try</span>
        <span class="hl sym">{</span>
            FileStream file <span class="hl sym">=</span> <span class="hl kwa">new</span> <span class="hl kwd">FileStream</span><span class="hl sym">(</span>fileName<span class="hl sym">,</span> FileMode<span class="hl sym">.</span>Open<span class="hl sym">);</span>
            StreamReader streamIn <span class="hl sym">=</span> <span class="hl kwa">new</span> <span class="hl kwd">StreamReader</span><span class="hl sym">(</span>file<span class="hl sym">);</span>
            <span class="hl slc">// use ReadBlock to preserve the current line endings</span>
            <span class="hl kwb">int</span> charsIn <span class="hl sym">=</span> streamIn<span class="hl sym">.</span><span class="hl kwd">ReadBlock</span><span class="hl sym">(</span>fileIn<span class="hl sym">,</span> <span class="hl num">0</span><span class="hl sym">,</span> readSize<span class="hl sym">);</span>
            <span class="hl kwa">while</span> <span class="hl sym">(</span>charsIn <span class="hl sym">!=</span> <span class="hl num">0</span><span class="hl sym">)</span>
            <span class="hl sym">{</span>
                bufferIn<span class="hl sym">.</span><span class="hl kwd">Append</span><span class="hl sym">(</span>fileIn<span class="hl sym">,</span> <span class="hl num">0</span><span class="hl sym">,</span> charsIn<span class="hl sym">);</span>
                charsIn <span class="hl sym">=</span> streamIn<span class="hl sym">.</span><span class="hl kwd">ReadBlock</span><span class="hl sym">(</span>fileIn<span class="hl sym">,</span> <span class="hl num">0</span><span class="hl sym">,</span> readSize<span class="hl sym">);</span>
            <span class="hl sym">}</span>
            streamIn<span class="hl sym">.</span><span class="hl kwd">Close</span><span class="hl sym">();</span>
        <span class="hl sym">}</span> <span class="hl kwa">catch</span> <span class="hl sym">(</span>DirectoryNotFoundException e<span class="hl sym">) {</span>
            Console<span class="hl sym">.</span><span class="hl kwd">WriteLine</span><span class="hl sym">(</span>e<span class="hl sym">.</span><span class="hl kwd">ToString</span><span class="hl sym">());</span>
            <span class="hl kwd">Error</span><span class="hl sym">(</span><span class="hl str">&quot;Cannot find directory&quot;</span><span class="hl sym">,</span> fileName<span class="hl sym">);</span>
        <span class="hl sym">}</span> <span class="hl kwa">catch</span> <span class="hl sym">(</span>FileNotFoundException e<span class="hl sym">) {</span>
            Console<span class="hl sym">.</span><span class="hl kwd">WriteLine</span><span class="hl sym">(</span>e<span class="hl sym">.</span><span class="hl kwd">ToString</span><span class="hl sym">());</span>
            <span class="hl kwd">Error</span><span class="hl sym">(</span><span class="hl str">&quot;Cannot find file&quot;</span><span class="hl sym">,</span> fileName<span class="hl sym">);</span>
        <span class="hl sym">}</span> <span class="hl kwa">catch</span> <span class="hl sym">(</span>Exception e<span class="hl sym">) {</span>
            Console<span class="hl sym">.</span><span class="hl kwd">WriteLine</span><span class="hl sym">(</span>e<span class="hl sym">.</span><span class="hl kwd">ToString</span><span class="hl sym">());</span>
            <span class="hl kwd">Error</span><span class="hl sym">(</span><span class="hl str">&quot;Error reading file&quot;</span><span class="hl sym">,</span> fileName<span class="hl sym">);</span>
        <span class="hl sym">}</span>

        <span class="hl kwa">return</span> bufferIn<span class="hl sym">.</span><span class="hl kwd">ToString</span><span class="hl sym">();</span>
    <span class="hl sym">}</span>

    <span class="hl slc">///  Return the formatted text.</span>
    <span class="hl slc">///  Usually the text would be returned to  an edit control.</span>
    <span class="hl kwa">private static</span> <span class="hl kwb">void</span> <span class="hl kwd">SetText</span><span class="hl sym">(</span>String textOut<span class="hl sym">,</span> String fileName<span class="hl sym">)</span>
    <span class="hl sym">{</span>
        <span class="hl slc">// create a backup file</span>
        String origFileName <span class="hl sym">=</span> fileName <span class="hl sym">+</span>  <span class="hl str">&quot;.orig&quot;</span><span class="hl sym">;</span>
        File<span class="hl sym">.</span><span class="hl kwd">Delete</span><span class="hl sym">(</span>origFileName<span class="hl sym">);</span>                  <span class="hl slc">// remove a pre-existing file</span>
        FileInfo outFile <span class="hl sym">=</span> <span class="hl kwa">new</span> <span class="hl kwd">FileInfo</span><span class="hl sym">(</span>fileName<span class="hl sym">);</span>
        outFile<span class="hl sym">.</span><span class="hl kwd">MoveTo</span><span class="hl sym">(</span>origFileName<span class="hl sym">);</span>

        <span class="hl slc">// write the output file - same name as input</span>
        <span class="hl kwa">try</span> <span class="hl sym">{</span>
            <span class="hl kwb">char</span><span class="hl sym">[]</span> bufferOut <span class="hl sym">=</span> textOut<span class="hl sym">.</span><span class="hl kwd">ToCharArray</span><span class="hl sym">();</span>
            FileStream file <span class="hl sym">=</span> <span class="hl kwa">new</span> <span class="hl kwd">FileStream</span><span class="hl sym">(</span>fileName<span class="hl sym">,</span> FileMode<span class="hl sym">.</span>Create<span class="hl sym">);</span>
            StreamWriter streamOut <span class="hl sym">=</span> <span class="hl kwa">new</span> <span class="hl kwd">StreamWriter</span><span class="hl sym">(</span>file<span class="hl sym">);</span>
            streamOut<span class="hl sym">.</span><span class="hl kwd">Write</span><span class="hl sym">(</span>bufferOut<span class="hl sym">,</span> <span class="hl num">0</span><span class="hl sym">,</span> bufferOut<span class="hl sym">.</span>Length<span class="hl sym">);</span>
            streamOut<span class="hl sym">.</span><span class="hl kwd">Close</span><span class="hl sym">();</span>
        <span class="hl sym">}</span> <span class="hl kwa">catch</span> <span class="hl sym">(</span>Exception e<span class="hl sym">) {</span>
            Console<span class="hl sym">.</span><span class="hl kwd">WriteLine</span><span class="hl sym">(</span>e<span class="hl sym">.</span><span class="hl kwd">ToString</span><span class="hl sym">());</span>
            <span class="hl kwd">Error</span><span class="hl sym">(</span><span class="hl str">&quot;Error writing file&quot;</span><span class="hl sym">,</span> fileName<span class="hl sym">);</span>
        <span class="hl sym">}</span>

        <span class="hl kwa">return</span><span class="hl sym">;</span>
    <span class="hl sym">}</span>

<span class="hl sym">}</span>   <span class="hl slc">// class Example</span>


</pre>
    </div>
    <p>
        &nbsp;</p>
    <div class="code">
        <pre>

<span class="hl slc">// AStyleInterface.cs</span>

<span class="hl kwa">using</span> System<span class="hl sym">;</span>
<span class="hl kwa">using</span> System<span class="hl sym">.</span>Runtime<span class="hl sym">.</span>InteropServices<span class="hl sym">;</span>

<span class="hl slc">/// AStyleInterface contains methods to call the Artistic Style formatter.</span>
<span class="hl kwa">public class</span> AStyleInterface
<span class="hl sym">{</span>
    <span class="hl slc">// Cannot use String as a return value because Mono runtime will attempt to</span>
    <span class="hl slc">// free the returned pointer resulting in a runtime crash.</span>
    <span class="hl sym">[</span><span class="hl kwd">DllImport</span><span class="hl sym">(</span><span class="hl str">&quot;astyle&quot;</span><span class="hl sym">,</span> CallingConvention <span class="hl sym">=</span> CallingConvention<span class="hl sym">.</span>StdCall<span class="hl sym">)]</span>
    <span class="hl kwa">private static</span> extern IntPtr AStyleMain
    <span class="hl sym">(</span>
        <span class="hl sym">[</span><span class="hl kwd">MarshalAs</span><span class="hl sym">(</span>UnmanagedType<span class="hl sym">.</span>LPStr<span class="hl sym">)]</span> String sIn<span class="hl sym">,</span>
        <span class="hl sym">[</span><span class="hl kwd">MarshalAs</span><span class="hl sym">(</span>UnmanagedType<span class="hl sym">.</span>LPStr<span class="hl sym">)]</span> String sOptions<span class="hl sym">,</span>
        AStyleErrorDelgate errorFunc<span class="hl sym">,</span>
        AStyleMemAllocDelgate memAllocFunc
    <span class="hl sym">);</span>

    <span class="hl slc">// Cannot use String as a return value because Mono runtime will attempt to</span>
    <span class="hl slc">// free the returned pointer resulting in a runtime crash.</span>
    <span class="hl sym">[</span><span class="hl kwd">DllImport</span><span class="hl sym">(</span><span class="hl str">&quot;astyle&quot;</span><span class="hl sym">,</span> CallingConvention <span class="hl sym">=</span> CallingConvention<span class="hl sym">.</span>StdCall<span class="hl sym">)]</span>
    <span class="hl kwa">private static</span> extern IntPtr <span class="hl kwd">AStyleGetVersion</span><span class="hl sym">();</span>

    <span class="hl slc">// AStyleMain callbacks</span>
    <span class="hl kwa">private delegate</span> IntPtr <span class="hl kwd">AStyleMemAllocDelgate</span><span class="hl sym">(</span><span class="hl kwb">int</span> size<span class="hl sym">);</span>
    <span class="hl kwa">private delegate</span> <span class="hl kwb">void</span> AStyleErrorDelgate
    <span class="hl sym">(</span>
        <span class="hl kwb">int</span> errorNum<span class="hl sym">,</span>
        <span class="hl sym">[</span><span class="hl kwd">MarshalAs</span><span class="hl sym">(</span>UnmanagedType<span class="hl sym">.</span>LPStr<span class="hl sym">)]</span> String error
    <span class="hl sym">);</span>

    <span class="hl slc">// AStyleMain Delegates</span>
    <span class="hl kwa">private</span> AStyleMemAllocDelgate AStyleMemAlloc<span class="hl sym">;</span>
    <span class="hl kwa">private</span> AStyleErrorDelgate AStyleError<span class="hl sym">;</span>

    <span class="hl slc">/// Declare callback functions</span>
    <span class="hl kwa">public</span> <span class="hl kwd">AStyleInterface</span><span class="hl sym">()</span>
    <span class="hl sym">{</span>
        AStyleMemAlloc <span class="hl sym">=</span> <span class="hl kwa">new</span> <span class="hl kwd">AStyleMemAllocDelgate</span><span class="hl sym">(</span>OnAStyleMemAlloc<span class="hl sym">);</span>
        AStyleError <span class="hl sym">=</span> <span class="hl kwa">new</span> <span class="hl kwd">AStyleErrorDelgate</span><span class="hl sym">(</span>OnAStyleError<span class="hl sym">);</span>
    <span class="hl sym">}</span>

    <span class="hl slc">/// Call the AStyleMain function in Artistic Style.</span>
    <span class="hl slc">/// An empty string is returned on error.</span>
    <span class="hl kwa">public</span> String <span class="hl kwd">FormatSource</span><span class="hl sym">(</span>String textIn<span class="hl sym">,</span> String options<span class="hl sym">)</span>
    <span class="hl sym">{</span>
        <span class="hl slc">// Return the allocated string</span>
        <span class="hl slc">// Memory space is allocated by OnAStyleMemAlloc, a callback function from AStyle</span>
        String sTextOut <span class="hl sym">=</span> String<span class="hl sym">.</span>Empty<span class="hl sym">;</span>
        <span class="hl kwa">try</span> <span class="hl sym">{</span>
            IntPtr pText <span class="hl sym">=</span> <span class="hl kwd">AStyleMain</span><span class="hl sym">(</span>textIn<span class="hl sym">,</span> options<span class="hl sym">,</span> AStyleError<span class="hl sym">,</span> AStyleMemAlloc<span class="hl sym">);</span>
            <span class="hl kwa">if</span> <span class="hl sym">(</span>pText <span class="hl sym">!=</span> IntPtr<span class="hl sym">.</span>Zero<span class="hl sym">) {</span>
                sTextOut <span class="hl sym">=</span> Marshal<span class="hl sym">.</span><span class="hl kwd">PtrToStringAnsi</span><span class="hl sym">(</span>pText<span class="hl sym">);</span>
                Marshal<span class="hl sym">.</span><span class="hl kwd">FreeHGlobal</span><span class="hl sym">(</span>pText<span class="hl sym">);</span>
            <span class="hl sym">}</span>
        <span class="hl sym">}</span> <span class="hl kwa">catch</span> <span class="hl sym">(</span>DllNotFoundException e<span class="hl sym">) {</span>
            Console<span class="hl sym">.</span><span class="hl kwd">WriteLine</span><span class="hl sym">(</span>e<span class="hl sym">.</span><span class="hl kwd">ToString</span><span class="hl sym">());</span>
        <span class="hl sym">}</span> <span class="hl kwa">catch</span> <span class="hl sym">(</span>EntryPointNotFoundException e<span class="hl sym">) {</span>
            Console<span class="hl sym">.</span><span class="hl kwd">WriteLine</span><span class="hl sym">(</span>e<span class="hl sym">.</span><span class="hl kwd">ToString</span><span class="hl sym">());</span>
        <span class="hl sym">}</span>
        <span class="hl kwa">return</span> sTextOut<span class="hl sym">;</span>
    <span class="hl sym">}</span>

    <span class="hl slc">/// Get the Artistic Style version number.</span>
    <span class="hl slc">/// An empty string is returned on error.</span>
    <span class="hl kwa">public</span> String <span class="hl kwd">GetVersion</span><span class="hl sym">()</span>
    <span class="hl sym">{</span>
        String sVersion <span class="hl sym">=</span> String<span class="hl sym">.</span>Empty<span class="hl sym">;</span>
        <span class="hl kwa">try</span> <span class="hl sym">{</span>
            IntPtr  pVersion <span class="hl sym">=</span> <span class="hl kwd">AStyleGetVersion</span><span class="hl sym">();</span>
            <span class="hl kwa">if</span> <span class="hl sym">(</span>pVersion <span class="hl sym">!=</span> IntPtr<span class="hl sym">.</span>Zero<span class="hl sym">) {</span>
                sVersion <span class="hl sym">=</span> Marshal<span class="hl sym">.</span><span class="hl kwd">PtrToStringAnsi</span><span class="hl sym">(</span>pVersion<span class="hl sym">);</span>
            <span class="hl sym">}</span>
        <span class="hl sym">}</span> <span class="hl kwa">catch</span> <span class="hl sym">(</span>DllNotFoundException e<span class="hl sym">) {</span>
            Console<span class="hl sym">.</span><span class="hl kwd">WriteLine</span><span class="hl sym">(</span>e<span class="hl sym">.</span><span class="hl kwd">ToString</span><span class="hl sym">());</span>
        <span class="hl sym">}</span> <span class="hl kwa">catch</span> <span class="hl sym">(</span>EntryPointNotFoundException e<span class="hl sym">) {</span>
            Console<span class="hl sym">.</span><span class="hl kwd">WriteLine</span><span class="hl sym">(</span>e<span class="hl sym">.</span><span class="hl kwd">ToString</span><span class="hl sym">());</span>
        <span class="hl sym">}</span>
        <span class="hl kwa">return</span> sVersion<span class="hl sym">;</span>
    <span class="hl sym">}</span>

    <span class="hl slc">// Allocate the memory for the Artistic Style return string.</span>
    <span class="hl kwa">private</span> IntPtr <span class="hl kwd">OnAStyleMemAlloc</span><span class="hl sym">(</span><span class="hl kwb">int</span> size<span class="hl sym">)</span>
    <span class="hl sym">{</span>
        <span class="hl kwa">return</span> Marshal<span class="hl sym">.</span><span class="hl kwd">AllocHGlobal</span><span class="hl sym">(</span>size<span class="hl sym">);</span>
    <span class="hl sym">}</span>

    <span class="hl slc">// Display errors from Artistic Style .</span>
    <span class="hl kwa">private</span> <span class="hl kwb">void</span> <span class="hl kwd">OnAStyleError</span><span class="hl sym">(</span><span class="hl kwb">int</span> errorNumber<span class="hl sym">,</span> String errorMessage<span class="hl sym">)</span>
    <span class="hl sym">{</span>
        Console<span class="hl sym">.</span><span class="hl kwd">WriteLine</span><span class="hl sym">(</span><span class="hl str">&quot;astyle error &quot;</span> <span class="hl sym">+</span> errorNumber <span class="hl sym">+</span> <span class="hl str">&quot; - &quot;</span> <span class="hl sym">+</span> errorMessage<span class="hl sym">);</span>
    <span class="hl sym">}</span>

<span class="hl sym">}</span>   <span class="hl slc">// class AStyleInterface</span>


</pre>
    </div>
    <p>
        &nbsp;</p>

    <center style="margin-left: -0.4in;">
        <a href="http://sourceforge.net/projects/astyle">
            <img src="http://sflogo.sourceforge.net/sflogo.php?group_id=2319&type=16" width="150" height="40" border="0" alt="[SourceForge.net]" /></a>
    </center>

    <p>
        &nbsp;</p>
</body>

</html>
